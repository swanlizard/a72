CC:	XOR	BX,BX
CCM:	MOV	AL,[BX+SI]
	CMP	AL,0
	JZ	CCT
	CMP	AL,0DH
	JZ	CCT
	CMP	AL,21H
	JC	CCK
	CMP	AL,22H
	JZ	CCQ
	CMP	AL,27H
	JZ	CCQ
	CMP	AL,30H
	JC	CCS
	CMP	AL,3AH
	JC	CCL
	CMP	AL,3BH
	JZ	CCT
	CMP	AL,41H
	JC	CCS
	CMP	AL,5BH
	JC	CCL
	CMP	AL,5FH
	JZ	CCL
	CMP	AL,61H
	JC	CCS
	CMP	AL,7BH
	JNC	CCS
	AND	AL,0DFH
	MOV	[BX+SI],AL
CCL:	INC	BX
	JMP	SHORT CCM
CCK:	TEST	BX,BX
	JNZ	CCT
	INC	SI
	JMP	SHORT CCM
CCS:	TEST	BX,BX
	JZ	CCE
CCT:	MOV	AL,[SI]
	TEST	BX,BX
	RET
CCQ:	TEST	BX,BX
	JNZ	CCT
CCW:	INC	BX
	CMP	AL,[BX+SI]
	JNZ	CCW
CCE:	INC	BX
	RET
AA:	CMP	AX,80H
	JC	AA1
	CMP	AX,0FF80H
	RET
AA1:	CMC
	RET
SL:	CLD
	MOV	DX,[DI]
SL1:	INC	DI
	INC	DI
	DEC	DX
	JS	SL5
	MOV	AL,[BX+DI]
	TEST	AL,AL
	JNZ	SL3
	MOV	CX,BX
SL2:	DEC	BX
	JS	SL4
	MOV	AL,[BX+DI]
	AND	AL,7FH
	XOR	AL,[BX+SI]
	JZ	SL2
	MOV	BX,CX
SL3:	STC
	SBB	CX,CX
	XOR	AL,AL
	REPNE SCASB
	JZ	SL1
	JNZ	SL5
SL4:	MOV	BX,CX
	MOV	AX,[BX+DI+1]
	ADD	SI,BX
	XOR	BX,BX
SL5:	RET
HALX:	PUSH	AX
	SHR	AL,1
	SHR	AL,1
	SHR	AL,1
	SHR	AL,1
	CALL	HALL
	POP	AX
HALL:	AND	AL,0FH
	OR	AL,30H
	CMP	AL,3AH
	JC	HALN
	ADD	AL,7
HALN:	STOSB
	RET
RN:	CLD
	XOR	DX,DX
	CMP	CL,5
	JC	RN1
	XOR	CL,CL
RN1:	TEST	CL,CL
	JNZ	RN2
	SHL	DX,1
	MOV	AX,DX
	SHL	DX,1
	SHL	DX,1
	ADD	DX,AX
RN2:	SHL	DX,CL
	XOR	AH,AH
	LODSB
	SUB	AL,30H
	CMP	AL,0AH
	JC	RN3
	SUB	AL,7
;	CMP	AL,10H
;	JB	RN3
;	SUB	AL,20H
	CMP	AL,0FH
	JNBE	RN0
RN3:	ADD	DX,AX
	DEC	BX
	JNZ	RN1
RN0:	RET
WN:	CLD
	CMP	AX,CX
	JNC	WN1
	CMP	AX,10
	JNC	WN1
	OR	AL,30H
	STOSB
	RET
WN1:	MOV	SI,DI
WN2:	XOR	DX,DX
	DIV	CX
	XCHG	AX,DX
	CMP	AL,10
	SBB	AL,105
	DAS
	STOSB
	XCHG	AX,DX
	TEST	AX,AX
	JNZ	WN2
	CMP	DL,58
	JC	WN5
	MOV	AL,48
	STOSB
WN5:	MOV	CX,DI
	SUB	CX,SI
	SHR	CX,1
	JZ	WN0
	SUB	DI,CX
	ADD	SI,CX
WN4:	DEC	SI
	MOV	AL,[DI]
	XCHG	[SI],AL
	STOSB
	LOOP	WN4
WN0:	RET
LBL:	CALL	CC
	MOV	AL,[FUNC]
	AND	AL,3
	JZ	LBL2
	MOV	DI,[SYM]
	CALL	SL
	JZ	LBL3
	MOV	CX,BX
	CLD
	REP MOVSB
	XOR	AL,AL
	STOSB
	MOV	BX,[SYM]
	INC	WORD [BX]
LBL1:	MOV	BP,DI
	MOV	AX,[PC]
	ADD	AX,[VORG]
	STOSW
	XOR	BX,BX
LBL2:	ADD	SI,BX
	CALL	CC
	JZ	ERR3
	CMP	AL,3AH
	JNZ	$+3
	INC	SI
	RET
LBL3:	ADD	DI,CX
	INC	DI
	MOV	AL,2
	AND	AL,[FUNC]
	JNZ	LBL1
	MOV	AL,0AH
	JMP	FAIL
ERR3:	MOV	AL,3
	JMP	FAIL
SETDFB:	MOV	DI,[BINBUF]
	XOR	CX,CX
SETD1:	CALL	CC
	JZ	ERR8
	CMP	AL,3FH
	JZ	SETD5
;	TEST	CL,CL
;	JZ	SETD2
	PUSH	AX
	XOR	AX,AX
	REP STOSB
	POP	AX
SETD2:	CMP	AL,22H
	JZ	SETD6
	CMP	AL,27H
	JZ	SETD6
SETD3:	PUSH	CX
	PUSH	DI
	CALL	RI
	POP	DI
	POP	CX
	STOSW
	CMP	BYTE [OPCODE],2
	JZ	SETD7
	JNC	SETD4
	DEC	DI
	JMP	SHORT SETD7
SETD4:	SHL	AX,1
	SBB	AL,AL
	PUSH	CX
	MOV	CL,[OPCODE]
	SUB	CL,2
	REP STOSB
	POP	CX
	JMP	SHORT SETD7
SETD5:	ADD	CL,[OPCODE]
	INC	SI
	JMP	SHORT SETD7
SETD6:	MOV	AL,[OPCODE]
	ADD	AL,3
	CMP	BL,AL
	JB	SETD3
	PUSH	CX
	MOV	CX,BX
	SUB	CX,2
	INC	SI
	REP MOVSB
	INC	SI
	POP	CX
SETD7:	CALL	CC
	JZ	SETD8
	CMP	AL,2CH
	JNZ	ERR1
	INC	SI
	JMP	SHORT SETD1
SETD8:	ADD	[USIZE],CX
	ADD	[PC],CX
	MOV	CX,DI
	SUB	CX,[BINBUF]
	ADD	[BINLEN],CX
	ADD	[PC],CX
	CLC
	RET
ERR8:	MOV	AL,8
	JMP	SHORT FAIL
ERR1:	MOV	AL,1
	JMP	SHORT FAIL
SETINC:	CALL	CC
	JZ	ERR8
	CMP	AL,22H
	JZ	SETIN1
	CMP	AL,27H
	JNZ	SETIN2
SETIN1:	INC	SI
	SUB	BX,2
	JBE	ERR8
	RET
SETIN2:	XOR	BX,BX
SETIN3:	INC	BX
	MOV	AL,[BX+SI]
	CMP	AL,3BH
	JZ	SETEND
	CMP	AL,21H
	JNC	SETIN3
SETEND:	MOV	AL,[OPCODE]
FAIL:	MOV	SP,[STK]
	CMP	AL,5
	JNZ	FAIL0
	MOV	DX,[IMM]
	TEST	DX,DX
	JNS	FAIL1
	NOT	DX
FAIL1:	SUB	DX,7FH
FAIL0:	STC
	RET
RE:	XOR	CL,CL
	XOR	AX,AX
	MOV	[IMM],AX
REA:	CALL	CC
	JZ	RED
	CMP	AL,2BH
	JZ	REC
	CMP	AL,2DH
	JZ	REB
	PUSH	DX
	CALL	GV
	POP	DX
	JC	RED
	ADD	[IMM],AX
	JMP	SHORT REA
REB:	XOR	CL,80H
REC:	AND	CL,0BFH
	INC	SI
	JMP	SHORT REA
RED:	TEST	CL,40H
	JZ	ERR8
	MOV	AX,[IMM]
	RET
GV:	TEST	CL,40H
	JNZ	GVA
	CMP	AL,DL
	JZ	GVC
	CMP	AL,22H
	JZ	GVQ
	CMP	AL,27H
	JZ	GVQ
	CALL	RNM
	JZ	GV
	CALL	RNC
	JNC	GVV
	CMP	AL,40H
	JC	GVA
	MOV	AL,[FUNC]
	AND	AL,3
	JNZ	GVL
GVC:	ADD	SI,BX
	OR	CL,1
	MOV	DX,[PC]
	ADD	DX,[VORG]
	JMP	SHORT GVV
GVA:	STC
	RET
GVQ:	MOV	DX,[SI+1]
	ADD	SI,BX
	CMP	BX,5
	JNC	GV7
	CMP	BX,4
	JNC	GVV
	CMP	BX,3
	JC	GV8
	XOR	DH,DH
	JMP	SHORT GVV
GV7:	MOV	AL,7
	JMP	FAIL
GV8:	MOV	AL,8
	JMP	FAIL
GVL:	PUSH	CX
	MOV	DI,[SYM]
	CALL	SL
	POP	CX
	MOV	DX,8002H
	XCHG	DX,AX
	JZ	GVL1
	TEST	AL,[FUNC]
	JZ	GVC
	MOV	AL,4
	JMP	FAIL
GVL1:	TEST	DH,DH
	JNZ	GVL3
	TEST	AL,[FUNC]
	JNZ	GVL2
	OR	[DI],AH
GVL2:	TEST	[DI],AH
	JNZ	GVV
GVL3:	OR	CL,2
GVV:	OR	CL,40H
	TEST	CL,CL
	JNS	GVNS
	XOR	CL,80H
	NEG	DX
GVNS:	TEST	CL,10H
	JNZ	GVWO
	TEST	CL,8
	JNZ	GVHB
	TEST	CL,4
	JNZ	GVLB
	JMP	SHORT GVWO
GVHB:	TEST	CL,4
	JNZ	GVWO
	XCHG	DL,DH
GVLB:	XOR	DH,DH
	AND	CL,0FCH
GVWO:	MOV	AX,DX
	CLC
	RET
SETORG:	CALL	RI
	MOV	[VORG],AX
	CLC
	RET
SETDFS:	CALL	RI
	ADD	[USIZE],AX
	ADD	[PC],AX
	CLC
	RET
SETEQU:	MOV	AL,[FUNC]
	TEST	AL,3
	JZ	SETEQ0
	CALL	RI
	MOV	DI,BP
	STOSW
SETEQ0:	CLC
	RET
