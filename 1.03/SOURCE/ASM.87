ASM:		XOR AX, AX
		MOV [OUTPUT], AL
		MOV [STK], SP
		MOV DI, OFFSET FLAGS
		MOV CX, 15
		CLD
	REPZ	STOSB
		MOV BP, SI
ASML:		CALL CC
		JC ASM0
		MOV DI, OFFSET I8086
		CALL SL
		JC NOGOOD
		ADD SI, BX
		MOV [OPCODE], AL
		OR BYTE PTR [FLAGS], 20H
		XOR AL, AL
		XCHG AL, AH
		SHL AX, 1
		ADD AX, OFFSET IHDL
		MOV BX, AX
		CALL [BX]
		CALL CC
		JNC ASMX
		OR BYTE PTR [FLAGS], 0
		JNZ WRITE
		OR BYTE PTR [OUTPUT], 0
		JZ ASM0
		JMP WRD
ASM0:		CLC
		RET
ASMX:		MOV AL, 9
		JMP FAIL
NOGOOD:		CALL SCREG
		JC BAD
		CALL GSPR
		JNC WRITE
		MOV AL, 0CH
		JMP FAIL
BAD:		MOV CX, BX
		CMP BYTE PTR [FUNC], 1
		JNZ BADX
		MOV DI, OFFSET SYMBS
		CALL SL
		JNC BADFA
		CLD
		MOV AL, CL
		STOSB
	REPZ	MOVSB
		MOV AX, [PC]
		ADD AX, [VORG]
		STOSW
		INC WORD PTR [SYMBS]
BADX:		ADD SI, CX
		CALL CC
		JC BADF3
		CMP AL, 3AH
		JNZ NOCOL
		INC SI
NOCOL:		MOV SP, [STK]
		JMP ASML
BADF3:		MOV AL, 3
		JMP FAIL
BADFA:		MOV AL, 0AH
		JMP FAIL
WRITE:		CLD
		MOV DI, OFFSET OUTPUT+1
		MOV SI, OFFSET PREFIX
		MOV DL, [FLAGS]
		LODSB
		TEST DL, 80H
		JZ NOPREF
		STOSB
NOPREF:		MOV AL, [FPREF]
		OR AL, AL
		JZ NOFPR
		STOSB
NOFPR:		LODSB
		TEST DL, 40H
		JZ NOSPR
		STOSB
NOSPR:		LODSB
		TEST DL, 20H
		JZ NOOPC
		STOSB
NOOPC:		LODSB
		TEST DL, 10H
		JZ NOMOD
		STOSB
NOMOD:		LODSW
		TEST DL, 8
		JZ WNDISP
		TEST DL, 4
		JZ WBDISP
		STOSB
		MOV AL, AH
WBDISP:		STOSB
WNDISP:		LODSW
		TEST DL, 2
		JZ WNIMM
		TEST DL, 1
		JZ WBIMM
		STOSB
		MOV AL, AH
WBIMM:		STOSB
WNIMM:		MOV AX, DI
		SUB AX, OFFSET OUTPUT+1
		MOV [OUTPUT], AL
WRD:		XOR AH, AH
		MOV AL, [OUTPUT]
		ADD [PC], AX
		CLC
		RET
